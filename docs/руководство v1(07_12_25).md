# Руководство пользователя — ПО Lidar

Ниже — пошаговое руководство по работе с приложением, предполагается что сервер 
уже запущен и вы видите стартовую страницу в браузере http://localhost:8001/ .

## Кратко о том, как устроено приложение

Приложение — веб-интерфейс для управления съёмкой, облаков точек с удалённого 
LiDAR-устройства, загрузка файлов облака точек как из отдельных .txt файлов,
так и из ЦХД, а также их визуализация. 

Основные страницы:

- ```Логотип``` — публичная и личная стартовая страница с документацией.
- ```Вкладка регистрация``` — регистрация нового пользователя.
- ```Вкладка Вход и кнопка Войти``` — форма входа.
- ```Создание облака точек``` — страница ручной загрузки файла с облаком точек и созранения облака точек в базе данных.
- ```Просмотр облака точек``` — страница просмотра (визуализации) доступных пользователю облаков точек
- ```Подключение к ЦХД``` — страница подключения к ЦХД, а также синхронизации доступных ему съемок.
- ```Снять облако точек``` — страница управления съёмкой при помощи LiDAR облака точек.

API машруты доступны в файле: [docs/api v1(07_12_25).md](https://github.com/S-Kitaev/LidarPointCloudService/blob/main/docs/api%20v1(07_12_25).md)

## Стартовая страница
Это стартовая страница, которую вы увидите при входе в веб-интерфейс.

![i10.jpg](images%2Fi10.jpg)

Чтобы начать работу, вам нужно авторизоваться. Для этого, нажмите на кнопку ```Войти``` в правом верхнем углу, или на кнопку ```Войти в систему``` внизу по центру экрана. Они идентичны по своему функционалу.

## Регистрация и вход

1. Перейдите на /registration. Заполните username, email, password и password2. Приложение валидирует ввод (макс. длина, корректность e-mail).
![i2.jpg](images%2Fi2.jpg)
2. После успешной регистрации вы будете переадресованы на /login.
![i1.jpg](images%2Fi1.jpg)
3. На /login введите username и password. При успешном входе сервер:
- выдаст JWT токен и установит cookie Authorization: Bearer <token> (httponly).
- перенаправит вас на вашу личную страницу /{user_id}.

Если вы получили 401 — проверьте правильность логина/пароля и наличие cookie.

Личный кабинет /{user_id}

На этой странице вы видите приветствие и ссылки на разделы: создание, просмотр, подключение к ЦХД и управление съёмкой (capture). Большая часть функционала защищена — без JWT cookie вы будете перенаправлены на страницу входа.

## Главная страница
На этой странице можно посмотреть документацию и инструкции к работе с системой. На эту страницу можно перейти в любой момент, нажав на логотип проекта.

![i11.jpg](images%2Fi11.jpg)

При переходе по кнопке ```Документация```, вы попадете на страницу, где размещены внешние ссылки на документы в Github  репозитории проекта, а именно: Функциональные и нефункциональные требования, Техническое задание к системе, Технические требования к системе, Концепт проекта, Обоснования проекта, Программа испытаний. Для их просмотра требуется подключение к интернету.

При переходе по кнопке ```Инструкция```, вы попадете на страницу, где размещены кнопки перехода на следующие документы: 
Руководство пользователя (то, которое вы сейчас читаете), Руководство по запуску, API. Они являются локальными копиями инструкций из Github репозитория проекта, и не требуют интернета для просмотра.

## Страница «Создание облака точек»
![i3.jpg](images%2Fi3.jpg)
1. Левая половина страницы - Параметры эксперимента. Это место для записи метаданных облака точек:
    - Дата проведения съемки
    - Описание помещения, где проводилась съемка
    - Адрес помещения, где проводилась съемка
    - Описание объекта съемки
2. Правая половина страницы - Загрузка данных измерений
   - Область для перетаскивания/загрузки файла с облаком точек
   - Небольшая область с просмотром первых записей в файле в виде таблицы
3. Кнопка ```Сохранить эксперимент``` чтобы полученное облако точек перенести в базу данных, для дальнейшей работы

## Страница «Просмотр облака точек» 

Страница для просмотра облака точек, состоит из блоков - загруженных облаков точек с их описанием. 
![i4.jpg](images%2Fi4.jpg)
При нажатии на блок можно просмотреть само облако в 3D визуализаторе.
![i6.jpg](images%2Fi6.jpg)

## Страница «ЦХД» 
Страница для просмотра сохраненных в ЦХД облаков точек пользователей. Показываются только те эксперименты, которые относятся к конкретному пользователю(маппинг по логину и email)
![i9.jpg](images%2Fi9.jpg)

Кнопка ```Синхронизировать``` запускает процесс синхронизации между локальной базой данных и ЦХД. В данной реализации сохраняются ВСЕ локальные эксперименты ВСЕХ пользователей одним нажатием. Сопоставление пользователей в локальной базе данных и цхд происходит по логину и email. Эксперименты с полностью идентичными полями(Дата эксперимента, адрес, описания объекта и помещения), которые снял один и тот же пользователь, считаются синхронизированными и не добавляются в цхд.

## Страница «Снять облако точек» 

Перейдите на страницу «Снять облако точек». Страница устроена в две колонки: слева — блоки «Подключение» и «Параметры съёмки», справа — лог выполнения (консоль в браузере). Перед работой с лидаром, подключитесь к wi-fi лидара, чтобы иметь доступ к управлению.
![i5.jpg](images%2Fi5.jpg)

1. **Выезжающие окна:** по умолчанию оба свернуты. Нажмите кнопку заголовка раздела, чтобы раскрыть параметры.

2. **Подключение к лидару**

   - Нажмите «Проверить соединение с лидаром» → выполняется пинг платы. В логе появится результат.
   - Нажмите «Подключиться к плате» → выполняется подключение переход и настройка необходимо директории на плате. При успехе кнопки тестов и запуска съёмки активируются, в логе вы увидите подтверждение.
   - Если подключение не проходит — проверьте сетевые параметры в .env / app.core.config (LIDAR_HOST, LIDAR_USER, LIDAR_PASS, LIDAR_REMOTE_PATH) и доступность устройства/порта.

3. **Параметры съёмки**

    - ```Диапазон``` — градусы (не более 240) Диапазон съемки облака точек, насколько повернется двигатель относительно стартового положения

    - ```Шаг``` — градусы (например 5) шаг поворота двигателя, чем меньше, тем больше положений съемки будет в итоге

    - ```Длительность``` — сек (сколько времени длится запись в одном положении) чем больше, тем больше точек будет сниматься

    - ```Задержка импульса``` — сек (например 0.006) при повороте двигателя, чем меньше стоит, тем быстрее будет поворачиваться двигатель

    - После подключения активируются кнопки:

      + «Проверка лидара» —  проверит работоспособность лидара и выведет лог в консоль.

      + «Проверка двигателя» — проверит работоспособность двигателя, повернет его на 240 градусов от начального положения и вернет в изначальное положение.

      + «Запуск съёмки» — запустит съемку облака точек, запишет облако точек в .txt файл на плате и вернет лог съемки.

      + «Прервать съемку» — доступна только во время активной съёмки, прерырвает съемку и возвращает двигатель, ПО и лидар в изначальное положение

      + «Скачать облако точек» — загружает файл с облаком точек с платы локально на хост в папку /scans

4. **Лог** (справа)

   - После запуска теста/скана клиент автоматически открывает WebSocket к /api/lidar/ws/{task_id}. Вся консольная информация (stdout/stderr/info) приходит сюда и отображается.

   - WebSocket автоматически закрывается после завершения задачи (сервер помечает done и очередь пуста).

### Где сохраняются файлы и как их получить

- На удалённом устройстве (Raspberry/плата) сканы записываются по пути, указанному в ```settings.LIDAR_REMOTE_PATH``` в подпапке ```scans/``` (то есть ```.../scans/<filename>```).

- Скачивание происходит через сервер. Сервер подключается по SFTP, копирует файл в папку ```scans``` в корне проекта и отдаёт его клиенту.

- На сервере путь сохранения: ```/<корень_проекта>/scans/<filename>.```

- Если скачивание не работает — проверьте права доступа на удалённой стороне, что файл действительно создан, и что сервер может открыть SFTP (лог ошибок возвращается в response).

## Поведение кнопок

- Кнопка Прервать съемку активна только во время работы съёмки. После окончания съёмки она деактивируется.

- Кнопка Запуск съёмки снова активна после окончания съемки и после скачивания результата — чтобы вы могли запускать серию съёмок.

- Кнопка Скачать облако точек активируется после успешной съёмки (сервер вернул filename) и остаётся активной до начала новой съёмки (что перезатрет предыдущий файл) — это поведение можно изменить, но текущая логика такова.

## Если что-то пошло не так — быстрое решение проблем

- Кнопки неактивны: убедитесь, что вы вошли в систему (JWT cookie установлено). Проверьте DevTools → Application → Cookies.

- Подключение к Raspberry Pi не проходит: проверьте сетевой доступ к хосту (ping), логин/пароль, путь LIDAR_REMOTE_PATH. Попробуйте вручную ssh user@host с сервера (или с вашей машины) для диагностики.

- Файлы не скачиваются: проверьте, что на удалённой стороне файл действительно создан (ls <remote_path>/scans), права доступа, и что сервер может открыть SFTP (лог ошибок возвращается клиенту).

- Если приложение в Docker и контейнер не может достучаться до pypi.org при сборке — это проблема сети/прокси/VPN. Для сборки образа в окружениях с VPN может потребоваться настроить Docker daemon для работы через VPN/proxy или запускать сборку на машине с доступом.

## Полезные советы для пользователей и администраторов

- API-документация доступна по /docs (Swagger UI) и /redoc. Там видно все эндпоинты и можно тестировать API (для защищённых маршрутов в Swagger нужно добавить Bearer токен).

- JWT хранится в HttpOnly cookie Authorization. Для ручного тестирования API используйте Authorization: Bearer <token>.

- Если нужно очистить сессию/выйти — удалите cookie Authorization в браузере.

- Логи съёмок доступны в режиме реального времени через WebSocket — это основной канал для обратной связи во время выполнения scan.py.

- Для дебага на сервере: смотреть логи Docker контейнеров (docker compose logs -f app) и/или логи uvicorn.